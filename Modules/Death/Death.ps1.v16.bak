<#
.SYNOPSIS
    Memento Mori - Mortality Counter UI

.DESCRIPTION
    This script generates a fullscreen, blocking WPF window with a major horror aesthetic overhaul.
    It now includes a dynamic mortality counter, typewriter text effect, CRT scanlines, a blurred 
    and glitching background, a live clock, and colored UI accents.

.NOTES
    Author: Gemini (Mortality Counter Version)
    Date: 2025-12-27
    Version: 16.0 "Mortality Counter"
#>

#region --- Setup & Configuration ---
$PSScriptRoot = Split-Path -Parent -Path $MyInvocation.MyCommand.Definition
$LogFilePath = Join-Path -Path $PSScriptRoot -ChildPath "Death.log"
$VisualsDir = Join-Path -Path $PSScriptRoot -ChildPath "Visuals"
$SoundFilePath = Join-Path -Path $PSScriptRoot -ChildPath "flatline.wav"

Add-Type -AssemblyName PresentationFramework, System.Windows.Forms

function Write-Log {
    param([string]$Message)
    
    # Ensure the module's log directory exists
    if (-not (Test-Path -Path $PSScriptRoot -PathType Container)) {
        New-Item -Path $PSScriptRoot -ItemType Directory -Force | Out-Null
    }

    $Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    "[$Timestamp] | DEATH | $Message" | Out-File -FilePath $LogFilePath -Append
}

# --- Mortality Counter Calculation ---
function Get-TimePassed {
    param([datetime]$StartDate)
    $EndDate = Get-Date
    $TimeSpan = New-TimeSpan -Start $StartDate -End $EndDate
    
    $Years = $EndDate.Year - $StartDate.Year
    $Months = $EndDate.Month - $StartDate.Month
    $Days = $EndDate.Day - $StartDate.Day

    if ($Days -lt 0) {
        $Months--
        $Days += Get-DaysInMonth -Year $StartDate.Year -Month $StartDate.Month
    }
    if ($Months -lt 0) {
        $Years--
        $Months += 12
    }
    return [pscustomobject]@{Years = $Years; Months = $Months; Days = $Days }
}
function Get-DaysInMonth {
    param($Year, $Month)
    return [System.DateTime]::DaysInMonth($Year, $Month)
}
$StartDate = [datetime]::ParseExact("18/08/2005", "dd/MM/yyyy", $null)
$TimePassed = Get-TimePassed -StartDate $StartDate
$LifetimeString = "You have been lucky for $($TimePassed.Years) years, $($TimePassed.Months) months, and $($TimePassed.Days) days... but you are dying."


# Get all images
$ImageFiles = Get-ChildItem -Path $VisualsDir -Include *.jpg, *.jpeg, *.png, *.webp, *.avif -Recurse
#endregion

#region --- WPF GUI Definition (Aesthetic Overhaul UI v16.0) ---
[xml]$Xaml = @"
<Window xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="MEMENTO MORI"
        WindowState="Maximized" WindowStyle="None" Topmost="True"
        Background="Black">

    <Window.Resources>
        <Storyboard x:Key="HeaderPulseAnimation">
            <DoubleAnimation Storyboard.TargetName="HeaderGlow" Storyboard.TargetProperty="BlurRadius" From="20" To="40" Duration="0:0:4" AutoReverse="True" RepeatBehavior="Forever" />
        </Storyboard>

        <Storyboard x:Key="ImageGlitchAnimation">
            <DoubleAnimationUsingKeyFrames Storyboard.TargetName="GlitchImageTranslate" Storyboard.TargetProperty="X" RepeatBehavior="Forever">
                <LinearDoubleKeyFrame Value="0" KeyTime="0:0:2" />
                <LinearDoubleKeyFrame Value="-15" KeyTime="0:0:2.05" />
                <LinearDoubleKeyFrame Value="15" KeyTime="0:0:2.1" />
                <LinearDoubleKeyFrame Value="0" KeyTime="0:0:2.15" />
                <LinearDoubleKeyFrame Value="0" KeyTime="0:0:4" />
                <LinearDoubleKeyFrame Value="20" KeyTime="0:0:4.05" />
                <LinearDoubleKeyFrame Value="-20" KeyTime="0:0:4.1" />
                <LinearDoubleKeyFrame Value="0" KeyTime="0:0:4.15" />
            </DoubleAnimationUsingKeyFrames>
        </Storyboard>
        
        <Storyboard x:Key="ScanlineFlickerAnimation">
            <DoubleAnimationUsingKeyFrames Storyboard.TargetProperty="Opacity" RepeatBehavior="Forever">
                <LinearDoubleKeyFrame Value="0.1" KeyTime="0:0:0.5" />
                <LinearDoubleKeyFrame Value="0.05" KeyTime="0:0:0.6" />
                <LinearDoubleKeyFrame Value="0.1" KeyTime="0:0:0.7" />
            </DoubleAnimationUsingKeyFrames>
        </Storyboard>

        <VisualBrush x:Key="ScanlineBrush" TileMode="Tile" Viewport="0,0,1,3" ViewportUnits="Absolute">
            <VisualBrush.Visual>
                <Rectangle Height="3" Width="1" Fill="Black"/>
            </VisualBrush.Visual>
        </VisualBrush>
        
        <Style x:Key="PainfulButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Black" />
            <Setter Property="Foreground" Value="#888888" />
            <Setter Property="BorderBrush"><Setter.Value><SolidColorBrush Color="#444444" /></Setter.Value></Setter>
            <Setter Property="BorderThickness" Value="2" />
            <Setter Property="FontFamily" Value="Impact"/>
            <Setter Property="FontSize" Value="28" />
            <Setter Property="Padding" Value="100,20" />
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Name="ButtonBorder" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" CornerRadius="0">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Foreground" Value="#FF0000"/>
                    <Setter Property="BorderBrush" Value="#FF0000"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>

    <Window.Triggers>
        <EventTrigger RoutedEvent="Window.Loaded">
            <BeginStoryboard Storyboard="{StaticResource HeaderPulseAnimation}" />
            <BeginStoryboard Storyboard="{StaticResource ImageGlitchAnimation}" />
        </EventTrigger>
    </Window.Triggers>

    <Grid>
        <Image x:Name="BackgroundImage" Stretch="Uniform" Opacity="0.2">
            <Image.Effect>
                <BlurEffect Radius="2"/>
            </Image.Effect>
            <Image.RenderTransform>
                <TranslateTransform x:Name="GlitchImageTranslate" X="0" Y="0" />
            </Image.RenderTransform>
        </Image>

        <Rectangle x:Name="ScanlineOverlay" Fill="{StaticResource ScanlineBrush}" Opacity="0.1" Panel.ZIndex="1" />

        <TextBlock x:Name="SakshiTag" Text="SAKSHI" Foreground="#AA0000" FontSize="12" FontWeight="Bold"
                   HorizontalAlignment="Left" VerticalAlignment="Top" Margin="20" Panel.ZIndex="2"/>

        <TextBlock x:Name="LifetimeText" Text="" Foreground="#AA0000" FontSize="12" FontWeight="Bold"
                   HorizontalAlignment="Center" VerticalAlignment="Top" Margin="20" Panel.ZIndex="2"/>

        <TextBlock x:Name="LiveClock" Text="00:00:00" Foreground="#AA0000" FontSize="12" FontWeight="Bold"
                   HorizontalAlignment="Right" VerticalAlignment="Top" Margin="20" Panel.ZIndex="2"/>

        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Margin="50" Panel.ZIndex="2">
            <TextBlock Text=" üíÄ MEMENTO MORI üíÄ " FontFamily="Courier New" FontSize="60" FontWeight="Bold" Foreground="#FF0000" TextAlignment="Center" Margin="0,0,0,50">
                <TextBlock.Effect><DropShadowEffect x:Name="HeaderGlow" Color="#AA0000" ShadowDepth="0" BlurRadius="30" Opacity="1.5"/></TextBlock.Effect>
            </TextBlock>
	    <TextBlock x:Name="BodyText0" Text="" FontFamily="Courier New" FontSize="48" FontWeight="Bold" Foreground="#FF0000" TextAlignment="Center" TextWrapping="Wrap" Margin="0,20" Visibility="Hidden"><TextBlock.Effect><DropShadowEffect Color="#AA0000" ShadowDepth="0" BlurRadius="10" Opacity="1"/></TextBlock.Effect></TextBlock>
            <TextBlock x:Name="BodyText1" Text="" FontFamily="Courier New" FontSize="48" FontWeight="Bold" Foreground="#FF0000" TextAlignment="Center" TextWrapping="Wrap" Margin="0,20" Visibility="Hidden"><TextBlock.Effect><DropShadowEffect Color="#AA0000" ShadowDepth="0" BlurRadius="10" Opacity="1"/></TextBlock.Effect></TextBlock>
            <TextBlock x:Name="BodyText2" Text="" FontFamily="Courier New" FontSize="48" FontWeight="Bold" Foreground="#FF0000" TextAlignment="Center" TextWrapping="Wrap" Margin="0,20" Visibility="Hidden"><TextBlock.Effect><DropShadowEffect Color="#AA0000" ShadowDepth="0" BlurRadius="10" Opacity="1"/></TextBlock.Effect></TextBlock>
            <TextBlock x:Name="BodyText3" Text="" FontFamily="Courier New" FontSize="48" FontWeight="Bold" Foreground="#FF0000" TextAlignment="Center" TextWrapping="Wrap" Margin="0,20" Visibility="Hidden"><TextBlock.Effect><DropShadowEffect Color="#AA0000" ShadowDepth="0" BlurRadius="10" Opacity="1"/></TextBlock.Effect></TextBlock>
            <TextBlock x:Name="BodyText4" Text="" FontFamily="Courier New" FontSize="48" FontWeight="Bold" Foreground="#FF0000" TextAlignment="Center" TextWrapping="Wrap" Margin="0,20,0,60" Visibility="Hidden"><TextBlock.Effect><DropShadowEffect Color="#AA0000" ShadowDepth="0" BlurRadius="10" Opacity="1"/></TextBlock.Effect></TextBlock>
            <Button Name="AcceptButton" Content=" Yes I am aware I am dying. " Style="{StaticResource PainfulButtonStyle}" HorizontalAlignment="Center" />
        </StackPanel>
        
        <Rectangle x:Name="FlashPanel" Fill="White" Visibility="Collapsed" Panel.ZIndex="3" />
    </Grid>
</Window>
"@
#endregion

#region --- GUI Logic & Execution ---
try {
    $Reader = [System.Xml.XmlNodeReader]::new($Xaml)
    $Window = [Windows.Markup.XamlReader]::Load($Reader)

    # --- Find UI Elements ---
    $AcceptButton = $Window.FindName("AcceptButton")
    $FlashPanel = $Window.FindName("FlashPanel")
    $BackgroundImage = $Window.FindName("BackgroundImage")
    $LiveClock = $Window.FindName("LiveClock")
    $LifetimeText = $Window.FindName("LifetimeText")
    
    # --- Set Lifetime Text ---
    $LifetimeText.Text = $LifetimeString

    # --- Image Changer Setup ---
    $ImageChangeTimer = New-Object System.Windows.Threading.DispatcherTimer
    $ImageChangeTimer.Interval = [TimeSpan]::FromSeconds(2)
    $ImageChange_Tick = {
        if ($ImageFiles.Count -gt 0) {
            $RandomImage = $ImageFiles | Get-Random
            $Bitmap = [System.Windows.Media.Imaging.BitmapImage]::new()
            $Bitmap.BeginInit()
            $Bitmap.UriSource = [System.Uri]$RandomImage.FullName
            $Bitmap.EndInit()
            $BackgroundImage.Source = $Bitmap
        }
    }
    $ImageChangeTimer.Add_Tick($ImageChange_Tick)

    # --- Clock Setup ---
    $ClockTimer = New-Object System.Windows.Threading.DispatcherTimer
    $ClockTimer.Interval = [TimeSpan]::FromSeconds(1)
    $Clock_Tick = {
        $LiveClock.Text = Get-Date -Format "HH:mm:ss"
    }
    $ClockTimer.Add_Tick($Clock_Tick)

    # --- Typewriter Effect Setup ---
    $TypewriterTimer = New-Object System.Windows.Threading.DispatcherTimer
    $TypewriterTimer.Interval = [TimeSpan]::FromMilliseconds(50)
    
    $TextBlocks = @(
        $Window.FindName("BodyText0"),
        $Window.FindName("BodyText1"),
        $Window.FindName("BodyText2"),
        $Window.FindName("BodyText3"),
        $Window.FindName("BodyText4")
    )
    $FullText = @(
        " üî• KARAN SINGH VERMA üî• ",
        " ‚ò†Ô∏è Be Aware Of Your Mortality ‚ò†Ô∏è ",
        " You Are Dying. ",
        " Your Days Are Numbered. ",
        " Accept Your Mortality. "
    )
    $CurrentLine = 0
    $CurrentChar = 0

    $Typewriter_Tick = {
        if ($CurrentLine -lt $TextBlocks.Count) {
            $TextBlock = $TextBlocks[$CurrentLine]
            $LineText = $FullText[$CurrentLine]

            if ($TextBlock.Visibility -ne 'Visible') {
                $TextBlock.Visibility = 'Visible'
            }

            if ($CurrentChar -lt $LineText.Length) {
                $CurrentChar++
                $TextBlock.Text = $LineText.Substring(0, $CurrentChar)
            } else {
                $CurrentLine++
                $CurrentChar = 0
            }
        } else {
            $TypewriterTimer.Stop()
        }
    }
    $TypewriterTimer.Add_Tick($Typewriter_Tick)

    # --- Initial Image Load ---
    if ($ImageFiles.Count -gt 0) {
        $RandomImage = $ImageFiles | Get-Random
        $Bitmap = [System.Windows.Media.Imaging.BitmapImage]::new()
        $Bitmap.BeginInit()
        $Bitmap.UriSource = [System.Uri]$RandomImage.FullName
        $Bitmap.EndInit()
        $BackgroundImage.Source = $Bitmap
        Write-Log "Mortality Counter UI loaded initial image: $($RandomImage.FullName)"
    } else {
        Write-Log "No images found in Visuals directory."
    }

    # --- Setup Sound Player ---
    $SoundPlayer = [System.Media.SoundPlayer]::new()
    if (Test-Path $SoundFilePath) { $SoundPlayer.SoundLocation = $SoundFilePath; $SoundPlayer.LoadAsync() }

    # --- Button Click Logic ---
    $AcceptButton.Add_Click({
        Write-Log "User acknowledged mortality (Mortality Counter UI)."
        $FlashPanel.Visibility = 'Visible'
        if ($SoundPlayer.IsLoadCompleted) { $SoundPlayer.PlaySync() }
        Start-Sleep -Milliseconds 50
        $Window.Close()
    })
    
    # --- Window Lifecycle Events ---
    $Window.Add_Loaded({
        # Start timers
        $ImageChangeTimer.Start()
        $ClockTimer.Start()
        $TypewriterTimer.Start()
        
        # Start scanline animation
        $ScanlineOverlay = $Window.FindName("ScanlineOverlay")
        $ScanlineStoryboard = $Window.Resources["ScanlineFlickerAnimation"]
        $ScanlineStoryboard.Begin($ScanlineOverlay)

        Write-Log "Mortality Counter UI Initialized."
    })

    $Window.Add_Closing({
        $ImageChangeTimer.Stop()
        $ClockTimer.Stop()
        $TypewriterTimer.Stop()
        $SoundPlayer.Dispose()
        Write-Log "Mortality Counter UI Closed."
    })

    # Execute the dialog window
    $Window.ShowDialog() | Out-Null

} catch {
    Write-Log "FATAL ERROR in Mortality Counter UI: $_"
}
#endregion
